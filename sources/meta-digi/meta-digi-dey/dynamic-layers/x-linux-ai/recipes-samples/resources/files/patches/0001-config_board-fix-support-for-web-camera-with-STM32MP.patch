From: Arturo Buzarra <arturo.buzarra@digi.com>
Date: Tue, 22 Apr 2025 14:01:12 +0200
Subject: [PATCH] config_board: fix support for web camera with STM32MP255
 processor

This commit disables the dual camera pipeline support for USB cameras, as it is
exclusive to cameras using the DCMIPP peripheral.

Signed-off-by: Arturo Buzarra <arturo.buzarra@digi.com>
---
 .../files/resources-files/config_board_npu.sh | 31 ++++++++++++++++++-
 1 file changed, 30 insertions(+), 1 deletion(-)

diff --git a/resources-files/config_board_npu.sh b/resources-files/config_board_npu.sh
index c89b5ca..af95558 100644
--- a/resources-files/config_board_npu.sh
+++ b/resources-files/config_board_npu.sh
@@ -16,10 +16,28 @@ STM32MP251="stm32mp251"
 STM32MP235="stm32mp235"
 STM32MP233="stm32mp233"
 STM32MP231="stm32mp231"
 STM32MP2_NPU="stm32mp2x with GPU/NPU"

+function is_dcmipp_present() {
+  DCMIPP_SENSOR="NOTFOUND"
+  # ov5640 or imx335 camera can be present on csi connector
+  for video in $(find /sys/class/video4linux -name "video*" -type l);
+  do
+    if [ "$(cat $video/name)" = "dcmipp_main_capture" ]; then
+      for sub in $(find /sys/class/video4linux -name "v4l-subdev*" -type l);
+      do
+        subdev_name=$(tr -d '\0' < $sub/name | awk '{print $1}')
+        if [ "$subdev_name" = "ov5640" ] || [ "$subdev_name" = "imx335" ]; then
+            DCMIPP_SENSOR=$subdev_name
+            break;
+        fi
+      done
+    fi
+  done
+}
+
 if [[ "$COMPATIBLE" == *"$STM32MP253"* ]] || [[ "$COMPATIBLE" == *"$STM32MP251"* ]] || [[ "$COMPATIBLE" == *"$STM32MP233"* ]] || [[ "$COMPATIBLE" == *"$STM32MP231"* ]]; then
   if [[ "$SOFTWARE" == "AI_NPU" ]]; then
     echo "Software X-LINUX-AI installed is not compatible with the board, please install X-LINUX-AI CPU version for plateform without hardware accelerator"
     exit 1
   fi
@@ -54,11 +72,22 @@ if [[ "$COMPATIBLE" == *"$STM32MP257"* ]] || [[ "$COMPATIBLE" == *"$STM32MP255"*
   MACHINE=$STM32MP2_NPU
   DWIDTH=760
   DHEIGHT=568
   DFPS=30
   COMPUTE_ENGINE="--npu"
-  OPTIONS="--dual_camera_pipeline"
+
+  is_dcmipp_present
+  if [ "$DCMIPP_SENSOR" != "NOTFOUND" ]; then
+    # DCMIPP camera
+    OPTIONS="--dual_camera_pipeline"
+  else
+    # Web camera
+    OPTIONS=""
+    DWIDTH=640
+    DHEIGHT=480
+  fi
+
   IMAGE_CLASSIFICATION_MODEL="mobilenet/mobilenet_v2_1.0_224_int8_per_tensor$NN_EXT"
   IMAGE_CLASSIFICATION_LABEL="mobilenet/labels_imagenet_2012"
   IMAGE_CLASSIF_DATA="mobilenet/testdata/"
   if [[ "$NN_EXT" == ".nb" ]]; then
     OBJ_DETEC_MODEL="coco_ssd_mobilenet/ssd_mobilenet_v2_fpnlite_10_256_int8_per_tensor$NN_EXT"
--
2.34.1
